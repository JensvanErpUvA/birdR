<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>aa-processing • birdar</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="aa-processing">
<meta property="og:description" content="birdar">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">birdar</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/aa-processing.html">aa-processing</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://gitlab.com/uva_ibed_ame/robin_radar/birdar" class="external-link">
    <span class="fa fa-gitlab"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="aa-processing_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>aa-processing</h1>
            
      
      
      <div class="hidden name"><code>aa-processing.Rmd</code></div>

    </div>

    
    
<div class="section level3">
<h3 id="loading-packages">Loading packages<a class="anchor" aria-label="anchor" href="#loading-packages"></a>
</h3>
<p>Load all required packages for the full post-processing method</p>
</div>
<div class="section level2">
<h2 id="settings-and-filenames">1.1 Settings and filenames<a class="anchor" aria-label="anchor" href="#settings-and-filenames"></a>
</h2>
<p>Here all required filenames, radar information and processing settings are specified</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## File names</span>
<span class="co">## Bird tracks</span>
<span class="va">radar_filename</span> <span class="op">&lt;-</span> <span class="st">"lud_bird-tracks_bare_w1_06-20.csv"</span>
<span class="co">## Radar masking intensity of the horizontal radar</span>
<span class="va">mask_filename</span> <span class="op">&lt;-</span> <span class="st">"lud_hor_landmask_06-20.csv"</span>
<span class="co">## ERA5 data</span>
<span class="va">ERA5_filename</span> <span class="op">&lt;-</span> <span class="st">"lud_ERA5_10m-windcomp_06-20.csv"</span>
<span class="co">## Turbine locations (all Dutch offshore turbines)</span>
<span class="co"># turbine_filename &lt;- "D:/SURFDrive/R/shapefiles/turbines_en_ohvs.shp"</span>
<span class="va">turbine_filename</span> <span class="op">&lt;-</span> <span class="st">"turbines_en_ohvs.shp"</span>

<span class="co">## General</span>
<span class="co">## Area name</span>
<span class="va">area_name</span> <span class="op">&lt;-</span> <span class="st">"Luchterduinen"</span>
<span class="co">## Start and end time of data (hourly resolution, UTC)</span>
<span class="va">data_start_time</span> <span class="op">&lt;-</span> <span class="fu">ymd_hms</span><span class="op">(</span><span class="st">"2020-06-01 00:00:00"</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span>
<span class="va">data_end_time</span> <span class="op">&lt;-</span> <span class="fu">ymd_hms</span><span class="op">(</span><span class="st">"2020-06-07 23:00:00"</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span>

<span class="co">## Radar coordinates [degrees]</span>
<span class="va">r_lon</span> <span class="op">&lt;-</span> <span class="fl">4.185345</span>
<span class="va">r_lat</span> <span class="op">&lt;-</span> <span class="fl">52.427827</span>

<span class="co">## Projections</span>
<span class="va">wgs84_epsg</span> <span class="op">&lt;-</span> <span class="fl">4326</span>
<span class="va">loc_epsg</span> <span class="op">&lt;-</span> <span class="fl">23095</span>
<span class="va">wgs84_proj</span> <span class="op">&lt;-</span> <span class="st">"+proj=longlat +datum=WGS84 +no_defs "</span>
<span class="va">loc_proj</span> <span class="op">&lt;-</span> <span class="st">"+proj=tmerc +lat_0=0 +lon_0=5 +k=0.9996 +x_0=500000 +y_0=0 +ellps=intl +towgs84=-87,-98,-121,0,0,0,0 +units=m +no_defs"</span>

<span class="va">radar</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">r_lon</span>, <span class="va">r_lat</span><span class="op">)</span><span class="op">)</span>,crs<span class="op">=</span><span class="fl">4326</span><span class="op">)</span>

<span class="co">## Module 1 parameters</span>
<span class="co">## Step 1</span>
<span class="co">## Set the minimum and maximum distance from the radar for reliable bird detection [m]</span>
<span class="va">mid</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">mad</span> <span class="op">&lt;-</span> <span class="fl">2500</span>
<span class="co">## The radar is situated near an offshore windfarm</span>
<span class="co">## Corner of the radar window the turbine blocks the radar</span>
<span class="co">## Corner of overlap between the horizontal and vertical radar (few horizontal-only tracks)</span>
<span class="va">b_corners</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">287</span>,<span class="fl">30</span><span class="op">)</span>,
                   <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">115</span>,<span class="fl">135</span><span class="op">)</span><span class="op">)</span>
<span class="co">## Turbine names (for coordinate extraction from main file)</span>
<span class="va">turbine_names</span> <span class="op">&lt;-</span> <span class="st">"Luchterduinen"</span>
<span class="co">## Turbine mask: circle radius</span>
<span class="va">turb_exclusion_rad</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co">## [metres]</span>
<span class="co">## Step 2</span>
<span class="co">## Minimum and maximum airspeed [m/s]</span>
<span class="va">min_airspeed</span> <span class="op">&lt;-</span> <span class="fl">5</span>
<span class="va">max_airspeed</span> <span class="op">&lt;-</span> <span class="fl">30</span>
<span class="co">## Percentiles to visualize for DoT threshold</span>
<span class="va">dot_percs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.002</span>,<span class="fl">0.02</span>,<span class="fl">0.002</span><span class="op">)</span>

<span class="co">## Module 2 parameters</span>
<span class="co">## Step 3</span>
<span class="co">## Minimum time interval between consequtive observations [s]. </span>
<span class="co">## This much shorter than the radar rotation speed to allow for differences in observation time (10%)</span>
<span class="va">min_time_inter</span> <span class="op">&lt;-</span> <span class="fl">1.2</span><span class="op">/</span><span class="fl">10</span> 

<span class="co">## Module 3 parameters</span>
<span class="co">## Step 5</span>
<span class="co">## Resolution of spatial raster for detecting spatial bias [m]</span>
<span class="va">raster_res</span> <span class="op">&lt;-</span> <span class="fl">100</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-loading-and-class-converting">1.1 Data loading and class-converting<a class="anchor" aria-label="anchor" href="#data-loading-and-class-converting"></a>
</h2>
<p>Should be user defined as this is highly specific to the user input and requirement. Perhaps there can be an “import function” for uvaRR that converts these variables from character strings automatically, but this is not high-priority</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Load in tracking data</span>
<span class="co">#tracks_all &lt;- fread(file=radar_filename)</span>
<span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">'../data/tracks_all.rda'</span><span class="op">)</span>

<span class="co">## Data contains two timestamps: the start and end of each track</span>
<span class="co">## Convert timestamps (characters) into POSIXct objects, with timezone = UTC</span>
<span class="va">tracks_all</span><span class="op">[</span>,<span class="va">timestamp_start</span> <span class="op">:=</span> <span class="fu">ymd_hms</span><span class="op">(</span><span class="va">timestamp_start</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span><span class="op">]</span>
<span class="va">tracks_all</span><span class="op">[</span>,<span class="va">timestamp_end</span> <span class="op">:=</span> <span class="fu">ymd_hms</span><span class="op">(</span><span class="va">timestamp_end</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span><span class="op">]</span>

<span class="co">## Convert trajectory into spatial class</span>
<span class="va">tracks_all</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">tracks_all</span>,
                       wkt<span class="op">=</span><span class="st">"trajectory"</span>,
                       crs<span class="op">=</span><span class="va">wgs84_epsg</span><span class="op">)</span>
<span class="va">tracks_all</span> <span class="op">&lt;-</span> <span class="fu">as.data.table</span><span class="op">(</span><span class="va">tracks_all</span><span class="op">)</span>

<span class="co"># sample for testing </span>
<span class="co">#tracks_all &lt;- tracks_all[sample(1:nrow(tracks_all),10000),]</span>

<span class="co">## Location specific: load in turbines</span>
<span class="co">## Load in turbines</span>
<span class="co">#all_turbs &lt;- as.data.table(st_read(turbine_filename))</span>
<span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">'../data/turbines.rda'</span><span class="op">)</span>
<span class="va">all_turbs</span> <span class="op">&lt;-</span> <span class="fu">as.data.table</span><span class="op">(</span><span class="va">turbines</span><span class="op">)</span>
<span class="co">## Our file contains data for all offshore turbines, so subset to the right wind farm</span>
<span class="va">turbines</span> <span class="op">&lt;-</span> <span class="va">all_turbs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">all_turbs</span><span class="op">$</span><span class="va">NAAM</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">turbine_names</span><span class="op">)</span>,<span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">all_turbs</span><span class="op">)</span>
<span class="co">## Convert coordinates into geometry to WGS84</span>
<span class="va">turbines</span><span class="op">[</span>,<span class="va">geometry</span><span class="op">:=</span><span class="fu">st_transform</span><span class="op">(</span><span class="va">geometry</span>,crs<span class="op">=</span><span class="va">wgs84_epsg</span><span class="op">)</span><span class="op">]</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sub-setting-based-on-prior-knowledge">2.1 Sub-setting based on prior knowledge<a class="anchor" aria-label="anchor" href="#sub-setting-based-on-prior-knowledge"></a>
</h2>
<div class="section level3">
<h3 id="spatial-filtering">2.1.1 Spatial filtering<a class="anchor" aria-label="anchor" href="#spatial-filtering"></a>
</h3>
<p>We apply the spatial filter by setting up an area of inclusion (AoI) geometry, which will be used to identify tracks outside of it to be removed. Three different filters can be used: - inclusion_ring: include region between a minimum and maximum distance from the radar location. - exclusion_angle: - exclusion_location:</p>
<p>This part is generally required, and setting up the AoI can be adopted into a function (minus the turbines, which is too specific imo).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">area_of_inclusion</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/roi.html">roi</a></span><span class="op">(</span>location<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4.185345</span>,<span class="fl">52.427827</span><span class="op">)</span>,
                         distance<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mad</span>,<span class="va">mid</span><span class="op">)</span>,
                         crs<span class="op">=</span><span class="va">loc_epsg</span>,
                         excl_angles<span class="op">=</span><span class="va">b_corners</span>,
                         excl_geom<span class="op">=</span><span class="va">turbines</span>,
                         excl_buffer<span class="op">=</span><span class="fl">100</span>,
                         verbose<span class="op">=</span><span class="cn">F</span>
                         <span class="op">)</span></code></pre></div>
<p><img src="aa-processing_files/figure-html/min_mad-1.png" width="700"><img src="aa-processing_files/figure-html/min_mad-2.png" width="700"><img src="aa-processing_files/figure-html/min_mad-3.png" width="700"><img src="aa-processing_files/figure-html/min_mad-4.png" width="700"><img src="aa-processing_files/figure-html/min_mad-5.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">## Add a tag to the turbines for whether they are in the proximity of the radar (bbox of AoI) mostly for plotting</span>
<span class="va">aoi_bbox</span> <span class="op">&lt;-</span> <span class="fu">st_as_sfc</span><span class="op">(</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">area_of_inclusion</span><span class="op">)</span>, crs<span class="op">=</span><span class="va">loc_epsg</span><span class="op">)</span>
<span class="va">turbines</span><span class="op">[</span>,<span class="va">near_aoi</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">turbines</span><span class="op">[</span>,<span class="va">geometry</span><span class="op">]</span>,<span class="va">st_within</span>,y<span class="op">=</span><span class="va">aoi_bbox</span>, sparse<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>This inclusion area can now be used to subset the data</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Include all tracks that cross the zone of inclusion</span>
<span class="va">tracks_all</span><span class="op">[</span>,<span class="va">intersects</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu">st_transform</span><span class="op">(</span><span class="fu">st_zm</span><span class="op">(</span><span class="va">trajectory</span><span class="op">)</span>, crs<span class="op">=</span><span class="va">loc_epsg</span><span class="op">)</span>, <span class="va">st_intersects</span>,
                               y<span class="op">=</span><span class="fu">st_transform</span><span class="op">(</span><span class="va">area_of_inclusion</span>, crs<span class="op">=</span><span class="va">loc_epsg</span><span class="op">)</span>, sparse<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">]</span>

<span class="co">## Filter tracks</span>
<span class="va">tracks_step1</span> <span class="op">&lt;-</span> <span class="va">tracks_all</span><span class="op">[</span><span class="va">intersects</span><span class="op">==</span><span class="cn">TRUE</span>,<span class="op">]</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="biological-filtering">2.1.2 Biological filtering<a class="anchor" aria-label="anchor" href="#biological-filtering"></a>
</h3>
<p>We have two track-specific filters</p>
<p>At this point we need to calculate several track parameters</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tracks_step1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/movement.html">movement</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">tracks_step1</span>,
                         metrics<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'n'</span>,<span class="st">'duration'</span>, <span class="st">'length'</span>, <span class="st">'groundspeed'</span>, <span class="st">'displacement'</span>, <span class="st">'direction'</span>,<span class="st">'dot'</span><span class="op">)</span>, 
                         crs<span class="op">=</span><span class="va">loc_epsg</span><span class="op">)</span>
<span class="co">#&gt; [1] "computed duration"</span>
<span class="co">#&gt; [1] "computed length"</span>
<span class="co">#&gt; [1] "computed groundspeed"</span>
<span class="co">#&gt; [1] "computed displacement"</span>
<span class="co">#&gt; [1] "computed direction"</span>
<span class="co">#&gt; [1] "removed columns: 0"</span></code></pre></div>
<p>Minimum and maximum airspeed</p>
<p>Firstly we will look at the average airspeed of each track, and filter airspeeds lower and higher than biologically relevant.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">'../data/era.rda'</span><span class="op">)</span>

<span class="va">tracks_step1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/annotation.html">weather</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">tracks_step1</span>,
                        era5<span class="op">=</span><span class="va">era</span>,
                        variables<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"U10m"</span>,<span class="st">"V10m"</span><span class="op">)</span>,
                        unit<span class="op">=</span><span class="st">"hours"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tracks_step1</span><span class="op">[</span>,<span class="va">airspeed</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">get_airspeed</span>, <span class="va">groundspeed</span>, <span class="va">direction</span>, <span class="va">U10m</span>, <span class="va">V10m</span><span class="op">)</span><span class="op">]</span>
<span class="va">tracks_step1</span> <span class="op">&lt;-</span> <span class="va">tracks_step1</span><span class="op">[</span><span class="va">airspeed</span><span class="op">&gt;=</span><span class="va">min_airspeed</span> <span class="op">&amp;</span> <span class="va">airspeed</span><span class="op">&lt;=</span><span class="va">max_airspeed</span>,<span class="op">]</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="non-biological-movement">2.1.3 Non-biological movement<a class="anchor" aria-label="anchor" href="#non-biological-movement"></a>
</h3>
<p>Secondly we identify non-biological movement (low displacement over time, or DoT) which is often related to clutter tracks. The threshold for what DoT is considered too low has to be set manually by the researcher through visually inspecting the data.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dot_perc_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_dot_percs.html">get_dot_percs</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">tracks_step1</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.002</span>,<span class="fl">0.02</span>,<span class="fl">0.002</span><span class="op">)</span>, context<span class="op">=</span><span class="va">area_of_inclusion</span><span class="op">)</span></code></pre></div>
<p><img src="aa-processing_files/figure-html/dot_threshold_calculations_visualizations-1.png" width="700"><img src="aa-processing_files/figure-html/dot_threshold_calculations_visualizations-2.png" width="700"><img src="aa-processing_files/figure-html/dot_threshold_calculations_visualizations-3.png" width="700"><img src="aa-processing_files/figure-html/dot_threshold_calculations_visualizations-4.png" width="700"><img src="aa-processing_files/figure-html/dot_threshold_calculations_visualizations-5.png" width="700"><img src="aa-processing_files/figure-html/dot_threshold_calculations_visualizations-6.png" width="700"><img src="aa-processing_files/figure-html/dot_threshold_calculations_visualizations-7.png" width="700"><img src="aa-processing_files/figure-html/dot_threshold_calculations_visualizations-8.png" width="700"><img src="aa-processing_files/figure-html/dot_threshold_calculations_visualizations-9.png" width="700"><img src="aa-processing_files/figure-html/dot_threshold_calculations_visualizations-10.png" width="700"></p>
<p>Based on the visualization, a stdp threshold has to be set</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dot_threshold</span> <span class="op">&lt;-</span> <span class="va">dot_perc_vals</span><span class="op">[</span><span class="st">"1%"</span><span class="op">]</span>
<span class="va">tracks_step2</span> <span class="op">&lt;-</span> <span class="va">tracks_step1</span><span class="op">[</span><span class="va">dot</span> <span class="op">&gt;</span> <span class="va">dot_threshold</span>,<span class="op">]</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="improving-the-quality-of-bird-tracks">2.2 Improving the quality of bird tracks<a class="anchor" aria-label="anchor" href="#improving-the-quality-of-bird-tracks"></a>
</h2>
<p>Erroneous points exist within some tracks, identifiable by a very short time-interval between those points and the next/previous point. Identify these intervals and remove both points involved with that interval, as there is no way to tell which of these two is faulty</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Copy tracks for last processing module</span>
<span class="va">error_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fix_geom.html">fix_geom</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">tracks_step2</span>, 
                         dt<span class="op">=</span><span class="va">min_time_inter</span><span class="op">)</span>
<span class="co">#&gt; [1] "calculate trajectory time interval"</span>
<span class="co">#&gt; [1] "identify trajectories with wrong points"</span>
<span class="co">#&gt; [1] "identify the correct points in the trajectories"</span>
<span class="co">#&gt; [1] "identify if the first or last point is removed"</span>
<span class="co">#&gt; [1] "trajectory corrected"</span>
<span class="co">#&gt; [1] "trajectory time corrected"</span>
<span class="co">#&gt; [1] "trajectory time interval corrected"</span>
<span class="co">#&gt; [1] "timestamp_end corrected"</span>
<span class="co">#&gt; [1] "duration corrected"</span>
<span class="co">#&gt; [1] "displacement corrected"</span>
<span class="co">#&gt; [1] "direction corrected"</span>
<span class="co">#&gt; [1] "n corrected"</span>
<span class="co">#&gt; [1] "length corrected"</span>
<span class="co">#&gt; [1] "groundspeed corrected"</span>
<span class="co">#&gt; [1] "airspeed corrected"</span>
<span class="va">tracks_step3</span> <span class="op">&lt;-</span> <span class="va">tracks_step2</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="removing-data-sections-with-negative-observation-bias">2.3 Removing data sections with negative observation bias<a class="anchor" aria-label="anchor" href="#removing-data-sections-with-negative-observation-bias"></a>
</h2>
</div>
<div class="section level2">
<h2 id="detecting-temporal-nob">2.3.1 Detecting temporal NOB<a class="anchor" aria-label="anchor" href="#detecting-temporal-nob"></a>
</h2>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Read in our NOB variable: masking data</span>
<span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">'../data/landmask.rda'</span><span class="op">)</span>
<span class="va">mask_data</span> <span class="op">&lt;-</span> <span class="va">landmask</span>
<span class="co">## Convert timestamp into POSIXct</span>
<span class="va">mask_data</span><span class="op">[</span>,<span class="va">timestamp</span><span class="op">:=</span><span class="fu">ymd_hms</span><span class="op">(</span><span class="va">timestamp</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tracks_step3</span> <span class="op">&lt;-</span><span class="fu"><a href="../reference/nob.html">nob</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">tracks_step3</span>, 
                   m<span class="op">=</span><span class="va">mask_data</span>, 
                   unit<span class="op">=</span><span class="st">'hour'</span><span class="op">)</span>
<span class="va">tracks_step4</span> <span class="op">&lt;-</span> <span class="va">tracks_step3</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="va">masked</span><span class="op">)</span>,<span class="op">]</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="detecting-spatial-bias">2.3.2 Detecting spatial bias<a class="anchor" aria-label="anchor" href="#detecting-spatial-bias"></a>
</h2>
<div class="section level3">
<h3 id="using-original-function-used-by-jens">using original function used by Jens<a class="anchor" aria-label="anchor" href="#using-original-function-used-by-jens"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">e</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">area_of_inclusion</span>,crs<span class="op">=</span><span class="va">loc_epsg</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">st_buffer</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">raster_res</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">st_transform</span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">area_of_inclusion</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">vect</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ext</span><span class="op">(</span><span class="op">)</span> 

<span class="va">track_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/track_density_rast.html">track_density_rast</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">tracks_step4</span><span class="op">[</span>,<span class="va">trajectory</span><span class="op">]</span>, 
                                   crs<span class="op">=</span><span class="va">loc_proj</span>, 
                                   e<span class="op">=</span><span class="va">e</span>,
                                   resolution <span class="op">=</span> <span class="va">raster_res</span><span class="op">)</span></code></pre></div>
<p>Visualization of the raster</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ## First visual inspection. Convert the data to a data.frame for plotting. Use the spatial mask set in step 2.1.1 to remove "dead" cells</span>
<span class="va">fig_rast_data</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">mask</span><span class="op">(</span><span class="va">track_raster</span>,<span class="fu">vect</span><span class="op">(</span><span class="va">area_of_inclusion</span><span class="op">)</span><span class="op">)</span>,xy<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">setnames</span><span class="op">(</span><span class="va">fig_rast_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>,<span class="st">"lat"</span><span class="op">)</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_tile</span><span class="op">(</span>data<span class="op">=</span><span class="va">fig_rast_data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">lon</span>,y<span class="op">=</span><span class="va">lat</span>,fill<span class="op">=</span><span class="va">tracks</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">area_of_inclusion</span>, fill<span class="op">=</span><span class="cn">NA</span>, colour<span class="op">=</span><span class="st">"black"</span>, lwd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">turbines</span><span class="op">[</span><span class="va">near_aoi</span><span class="op">==</span><span class="cn">TRUE</span>,<span class="va">geometry</span><span class="op">]</span>, colour<span class="op">=</span><span class="st">"black"</span>, lwd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">radar</span>, colour<span class="op">=</span><span class="st">"darkred"</span>, shape<span class="op">=</span><span class="fl">16</span>, lwd <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_fill_gradient</span><span class="op">(</span>low<span class="op">=</span><span class="st">"grey"</span>, high<span class="op">=</span><span class="st">"darkblue"</span>, name<span class="op">=</span><span class="st">"Number\n of tracks"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span>, title<span class="op">=</span><span class="va">area_name</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
        axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
        axis.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="aa-processing_files/figure-html/raster_visualization3-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="using-an-updated-function">using an updated function<a class="anchor" aria-label="anchor" href="#using-an-updated-function"></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">track_rasterB</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rasterizer.html">rasterizer</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu">vect</span><span class="op">(</span><span class="va">tracks_step4</span><span class="op">[</span>,<span class="va">trajectory</span><span class="op">]</span><span class="op">)</span>,
                           resolution<span class="op">=</span><span class="fl">100</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ## First visual inspection. Convert the data to a data.frame for plotting. Use the spatial mask set in step 2.1.1 to remove "dead" cells</span>
<span class="va">fig_rast_data</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">track_rasterB</span>,<span class="fu">vect</span><span class="op">(</span><span class="va">area_of_inclusion</span><span class="op">)</span><span class="op">)</span>,xy<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">setnames</span><span class="op">(</span><span class="va">fig_rast_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>,<span class="st">"lat"</span><span class="op">)</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_tile</span><span class="op">(</span>data<span class="op">=</span><span class="va">fig_rast_data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">lon</span>,y<span class="op">=</span><span class="va">lat</span>,fill<span class="op">=</span><span class="va">tracks</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">area_of_inclusion</span>, fill<span class="op">=</span><span class="cn">NA</span>, colour<span class="op">=</span><span class="st">"black"</span>, lwd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">turbines</span><span class="op">[</span><span class="va">near_aoi</span><span class="op">==</span><span class="cn">TRUE</span>,<span class="va">geometry</span><span class="op">]</span>, colour<span class="op">=</span><span class="st">"black"</span>, lwd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">radar</span>, colour<span class="op">=</span><span class="st">"darkred"</span>, shape<span class="op">=</span><span class="fl">16</span>, lwd <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_fill_gradient</span><span class="op">(</span>low<span class="op">=</span><span class="st">"grey"</span>, high<span class="op">=</span><span class="st">"darkblue"</span>, name<span class="op">=</span><span class="st">"Number\n of tracks"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span>, title<span class="op">=</span><span class="va">area_name</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
        axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
        axis.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="aa-processing_files/figure-html/raster_visualization2-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="analysis-of-the-raster-based-on-gam">analysis of the raster based on GAM<a class="anchor" aria-label="anchor" href="#analysis-of-the-raster-based-on-gam"></a>
</h3>
<p>Lastly, the spatial threshold should be set. This is based on the visualization of the gam again. In our example the gam curve itself is used to set the threshold. Here it is a bit more complicated to retrieve which cells cross the threshold. However I don’t know how useful a function for this would be still.</p>
</div>
<div class="section level3">
<h3 id="original-raster-function">original raster function<a class="anchor" aria-label="anchor" href="#original-raster-function"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#gam &lt;- rastgam(track_raster,radar=radar)</span>
<span class="va">tracks_step5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/distb.html">distb</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">tracks_step4</span>,<span class="va">track_raster</span>,radar<span class="op">=</span><span class="va">radar</span>,distance<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mid</span>,<span class="va">mad</span><span class="op">)</span><span class="op">)</span>
<span class="va">tracks_final</span> <span class="op">&lt;-</span> <span class="va">tracks_step5</span><span class="op">[</span><span class="va">crosses_raster</span><span class="op">==</span><span class="cn">TRUE</span>,<span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">tracks_final</span><span class="op">)</span>
<span class="co">#&gt; [1] 29551</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="updated-raster-function">updated raster function<a class="anchor" aria-label="anchor" href="#updated-raster-function"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#gam &lt;- rastgam(track_rasterB,radar=radar)</span>
<span class="va">tracks_step6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/distb.html">distb</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">tracks_step4</span>,<span class="va">track_rasterB</span>,radar<span class="op">=</span><span class="va">radar</span>,distance<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mid</span>,<span class="va">mad</span><span class="op">)</span><span class="op">)</span>
<span class="va">tracks_final</span> <span class="op">&lt;-</span> <span class="va">tracks_step6</span><span class="op">[</span><span class="va">crosses_raster</span><span class="op">==</span><span class="cn">TRUE</span>,<span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">tracks_final</span><span class="op">)</span>
<span class="co">#&gt; [1] 29409</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by First Last.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
